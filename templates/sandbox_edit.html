{% extends "sandbox_base.html" %}
{% block title %}Düzenle: {{ portfolio.name }}{% endblock %}
{% block content %}
    <h2>"{{ portfolio.name }}" Fonunu Düzenle</h2>
    <form id="edit-form">
        <h3>Hisse Senetleri</h3>
        <div id="stocks-container"></div>
        <button type="button" onclick="addAssetRow('stock')" style="background-color:#2ecc71; margin-top:10px;">Yeni Hisse Ekle</button>
        
        <h3 style="margin-top:25px;">Yatırım Fonları</h3>
        <div id="funds-container"></div>
        <button type="button" onclick="addAssetRow('fund')" style="background-color:#2ecc71; margin-top:10px;">Yeni Fon Ekle</button>
        
        <hr style="margin: 20px 0;">
        <button type="submit">Değişiklikleri Kaydet</button>
    </form>

<script>
    const holdings = {{ portfolio.holdings | tojson }};

    function addAssetRow(type, asset = { ticker: '', adet: '', weight: '' }) {
        const container = document.getElementById(type === 'stock' ? 'stocks-container' : 'funds-container');
        const newRow = document.createElement('div');
        newRow.style.display = 'grid';
        newRow.style.gridTemplateColumns = '2fr 1fr 1fr auto';
        newRow.style.gap = '10px';
        newRow.style.marginBottom = '10px';
        newRow.innerHTML = `
            <input type="text" placeholder="${type === 'stock' ? 'Hisse Kodu' : 'Fon Kodu'}" value="${asset.ticker || ''}" class="ticker">
            <input type="number" placeholder="Adet" value="${asset.adet || ''}" class="adet" min="0" step="1">
            <input type="number" placeholder="Ağırlık (%)" value="${asset.weight || ''}" class="weight" min="0" step="0.01">
            <button type="button" onclick="this.parentElement.remove()" style="background-color:#e74c3c;">X</button>
        `;
        container.appendChild(newRow);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        (holdings.stocks || []).forEach(stock => addAssetRow('stock', stock));
        (holdings.funds || []).forEach(fund => addAssetRow('fund', fund));
    });

    document.getElementById('edit-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const stocks = Array.from(document.querySelectorAll('#stocks-container > div')).map(row => ({
            ticker: row.querySelector('.ticker').value.toUpperCase().trim(),
            adet: row.querySelector('.adet').value,
            weight: row.querySelector('.weight').value
        })).filter(s => s.ticker); // boş olanları alma

        const funds = Array.from(document.querySelectorAll('#funds-container > div')).map(row => ({
            ticker: row.querySelector('.ticker').value.toUpperCase().trim(),
            adet: row.querySelector('.adet').value,
            weight: row.querySelector('.weight').value
        })).filter(f => f.ticker);
        
        const response = await fetch("{{ url_for('edit_sandbox_portfolio', portfolio_id=portfolio.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stocks, funds })
        });
        const result = await response.json();
        if (result.success) {
            alert('Değişiklikler kaydedildi!');
            window.location.href = result.redirect_url;
        } else {
            alert('Bir hata oluştu.');
        }
    });
</script>
{% endblock %}
