<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Fon Takip Uygulaması</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 20px auto; }
        .sidebar { flex: 1; min-width: 250px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); align-self: flex-start; }
        .content { flex: 3; min-width: 500px; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        h1, h2, h3 { color: #2c3e50; }
        h3 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 25px; }
        .stock-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .btn-add { background-color: #2ecc71; padding: 8px 15px; font-size: 14px; margin-top:10px; }
        .btn-remove { background-color: #e74c3c; padding: 5px 10px; font-size: 12px; } .btn-remove:hover { background-color: #c0392b; }
        .btn-save { background-color: #1abc9c; } .btn-save:hover { background-color: #16a085; }
        .btn-revert { background-color: #f39c12; margin-top: 20px; } .btn-revert:hover { background-color: #e67e22; }
        #total-result { font-size: 2.5em; font-weight: bold; margin-bottom: 20px; }
        .positive { color: #27ae60; } .negative { color: #c0392b; }
        .detail-table { width: 100%; margin-top: 10px; border-collapse: collapse; }
        .detail-table th, .detail-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .detail-table th { background-color: #bdc3c7; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-list { list-style-type: none; padding: 0; }
        .sidebar-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
        .sidebar-list li:hover, .sidebar-list li.active { background-color: #e0eafc; }
        
        /* --- DEĞİŞİKLİKLER BURADA --- */
        #options-menu {
            display: grid;
            /* Genişliğe göre otomatik olarak 2 veya daha fazla sütun oluşturur */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; /* Butonlar arası boşluk */
        }
        .options-menu button {
            background-color: #3498db; /* İstenen mavi renk */
            text-align: center; /* Yazıyı ortala */
            padding: 15px; /* İç boşluğu artır */
            box-sizing: border-box; /* Padding'in genişliği etkilememesi için */
            /* width, display:block ve margin-bottom kaldırıldı çünkü grid yapısı bunları yönetiyor. */
        }
        .options-menu button:hover {
            background-color: #2980b9; /* Hover rengi de ana renge uygun hale getirildi */
        }
        /* --- DEĞİŞİKLİKLERİN SONU --- */

        .back-button { font-size: 24px; position: absolute; top: 20px; left: 20px; cursor: pointer; color: #7f8c8d; transition: color 0.2s; text-decoration: none; }
        .back-button:hover { color: #2c3e50; }
        #live-return-display { text-align: center; padding: 15px; margin-top: 5px; margin-bottom: 25px; border: 1px solid #ecf0f1; border-radius: 6px; font-size: 1.4em; font-weight: bold; }
        .sidebar-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-actions button { width: 100%; text-align: center; padding: 10px; }
        #btn-delete-item { background-color: #e74c3c !important; }
        .comparison-selector { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: center; margin-bottom: 20px; padding: 15px; background-color: #ecf0f1; border-radius: 6px;}
        .comparison-selector div { flex: 1; min-width: 250px; }
        .comparison-selector label { font-weight: bold; display: block; margin-bottom: 5px; }
        #btn-switch-view { background-color: #f39c12 !important; margin-top: 5px; }
        #btn-switch-view:hover { background-color: #e67e22 !important; }
    </style>
</head>
<body>
<div class="main-container">
    <div class="sidebar">
        <h2 id="sidebar-title">Kaydedilmiş Fonlar</h2>
        <ul id="portfolio-list" class="sidebar-list"></ul>
        <ul id="composition-list" class="sidebar-list" style="display: none;"></ul>
        <div class="sidebar-actions">
            <button id="btn-new-item">Yeni Fon Ekle</button>
            <button id="btn-delete-item">Fonu Sil</button>
            <button id="btn-switch-view">Fon İçerikleri</button>
        </div>
    </div>
    <div class="content">
        <div class="container" id="options-container" style="display: none;">
            <h2 id="options-title"></h2>
            <div id="live-return-display">Hesaplanıyor...</div>
            <div id="options-menu"></div>
        </div>
        <div class="container" id="report-container" style="display: none;">
            <a href="#" class="back-button" title="Seçeneklere Geri Dön">&larr;</a>
            <h2 id="report-title" style="text-align:center;"></h2>
            <div style="width: 70%; margin: auto;"><canvas id="portfolioPieChart"></canvas></div>
        </div>
        <div class="container" id="comparison-container" style="display: none;">
            <a href="#" class="back-button" title="Seçeneklere Geri Dön">&larr;</a>
            <h2 id="comparison-title" style="text-align:center;"></h2>
            <div id="comparison-table-container"></div>
        </div>
        <div class="container" id="form-container" style="display: block;">
            <a href="#" class="back-button" title="Seçeneklere Geri Dön" style="display: none;">&larr;</a>
            <form id="portfolio-form">
                <div class="form-group">
                    <label id="form-name-label" for="portfolio-name">Fon Adı</label>
                    <input type="text" id="portfolio-name" required>
                </div>
                <h3>Hisse Senetleri</h3><div id="stocks-container"></div>
                <button type="button" class="btn-add" onclick="addAsset('stock')">Yeni Hisse Ekle</button>
                <h3>Yatırım Fonları</h3><div id="funds-container"></div>
                <button type="button" class="btn-add" onclick="addAsset('fund')">Yeni Fon Ekle</button>
                <hr style="margin: 20px 0;">
                <button type="submit">Hesapla</button>
                <button type="button" class="btn-save" id="save-button">Kaydet</button>
            </form>
        </div>
        <div class="container" id="result-area" style="display: none; text-align:center;">
            <a href="#" class="back-button" title="Seçeneklere Geri Dön">&larr;</a>
            <div class="loader" id="loader"></div>
            <div id="result-content" style="display: none;">
                <h2 id="result-title"></h2><div id="total-result"></div>
                <div id="stock-results-container" style="display:none; text-align:left;"></div>
                <div id="fund-results-container" style="display:none; text-align:left;"></div>
                <div id="historical-results-container" style="display:none; text-align:left; width: 95%; margin: auto;">
                    <canvas id="historicalLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentView = 'portfolio';
    let currentSelectedItemName = null;
    let portfolioChart = null;
    let historicalChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadPortfolios();
        loadCompositions();
        updateSidebarUI();
        document.getElementById('btn-switch-view').addEventListener('click', switchView);
        document.getElementById('btn-new-item').addEventListener('click', () => showFormForNew(currentView));
        document.getElementById('btn-delete-item').addEventListener('click', handleDeleteClick);
        document.getElementById('save-button').addEventListener('click', handleSave);
        document.getElementById('portfolio-form').addEventListener('submit', handleFormCalculate);
        document.querySelectorAll('.back-button').forEach(btn => btn.onclick = handleBackButtonClick);
    });

    function switchView() {
        currentView = (currentView === 'portfolio') ? 'composition' : 'portfolio';
        currentSelectedItemName = null;
        updateSidebarUI();
        showFormForNew(currentView);
    }

    function updateSidebarUI() {
        const isPortfolio = currentView === 'portfolio';
        document.getElementById('sidebar-title').textContent = isPortfolio ? 'Kaydedilmiş Fonlar' : 'Tanımlı Fon İçerikleri';
        document.getElementById('portfolio-list').style.display = isPortfolio ? 'block' : 'none';
        document.getElementById('composition-list').style.display = isPortfolio ? 'none' : 'block';
        document.getElementById('btn-new-item').textContent = isPortfolio ? 'Yeni Fon Ekle' : 'Yeni Fon İçeriği Ekle';
        document.getElementById('btn-delete-item').textContent = isPortfolio ? 'Fonu Sil' : 'İçeriği Sil';
        document.getElementById('btn-switch-view').textContent = isPortfolio ? 'Fon İçerikleri' : 'Ana Portföye Dön';
    }

    function showScreen(screenId) {
        ['options-container', 'report-container', 'comparison-container', 'form-container', 'result-area'].forEach(id => {
            document.getElementById(id).style.display = (id === screenId) ? 'block' : 'none';
        });
    }

    async function loadPortfolios() {
        const response = await fetch('/get_portfolios');
        const names = await response.json();
        const listEl = document.getElementById('portfolio-list');
        listEl.innerHTML = '';
        names.forEach(name => {
            const li = document.createElement('li');
            li.textContent = name; li.dataset.name = name;
            li.onclick = (e) => showOptions(name, 'portfolio', e.currentTarget);
            listEl.appendChild(li);
        });
    }

    async function loadCompositions() {
        const response = await fetch('/get_compositions');
        const names = await response.json();
        const listEl = document.getElementById('composition-list');
        listEl.innerHTML = '';
        names.forEach(name => {
            const li = document.createElement('li');
            li.textContent = name; li.dataset.name = name;
            li.onclick = (e) => showOptions(name, 'composition', e.currentTarget);
            listEl.appendChild(li);
        });
    }
    
    function showFormForNew(type) {
        currentSelectedItemName = null;
        document.querySelectorAll('.sidebar-list li').forEach(li => li.classList.remove('active'));
        document.getElementById('form-name-label').textContent = type === 'portfolio' ? 'Fon Adı' : 'Fon Kodu';
        const nameInput = document.getElementById('portfolio-name');
        nameInput.placeholder = type === 'portfolio' ? 'Yeni Fon Adı' : 'İçeriği Girilecek Fon Kodu (örn: T3B)';
        nameInput.value = '';
        document.getElementById('stocks-container').innerHTML = '';
        document.getElementById('funds-container').innerHTML = '';
        document.querySelector('#form-container .back-button').style.display = 'none';
        showScreen('form-container');
    }

    function showOptions(name, type, targetElement) {
        currentSelectedItemName = name;
        document.querySelectorAll('.sidebar-list li').forEach(li => li.classList.remove('active'));
        if (targetElement) targetElement.classList.add('active');
        document.getElementById('options-title').textContent = `"${name}" İçin İşlem Seçin`;
        const menu = document.getElementById('options-menu');
        menu.innerHTML = ''; 
        const buttons = [
            { text: '1. Fon Portföy Dağılımını Gör', action: () => displayPieChartReport(name, type) },
            { text: '2. Fon Portföyü Geçmişini Gör', action: () => displayWeightChangeReport(name, type) },
            { text: '4. Fon Portföy Dağılımı Değiştir', action: () => showFormForEdit(name, type) },
            { text: '5. Ağırlık Simülasyonu (Fiyata Göre)', action: () => displayDynamicWeightSimulation(name, type) }
        ];
        if (type === 'portfolio') {
            buttons.splice(2, 0, { text: '3. Son 30 Günlük Fon Getirisi', action: () => displayHistoricalReturns(name, type) });
        }
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.onclick = btnInfo.action;
            menu.appendChild(button);
        });
        fetchAndDisplayLiveReturn(name, type);
        showScreen('options-container');
    }

    async function showFormForEdit(name, type) {
        const endpoint = type === 'portfolio' ? `/get_portfolio/${name}` : `/get_composition/${name}`;
        const response = await fetch(endpoint);
        const data = await response.json();
        document.getElementById('form-name-label').textContent = type === 'portfolio' ? 'Fon Adı' : 'Fon Kodu';
        document.getElementById('portfolio-name').value = data.name;
        document.getElementById('stocks-container').innerHTML = '';
        (data.stocks || []).forEach(s => addAsset('stock', s.ticker, s.weight, s.adet));
        document.getElementById('funds-container').innerHTML = '';
        (data.funds || []).forEach(f => addAsset('fund', f.ticker, f.weight, f.adet));
        document.querySelector('#form-container .back-button').style.display = 'block';
        showScreen('form-container');
    }

    function addAsset(type, ticker = '', weight = '', adet = '') {
        const container = document.getElementById(type === 'stock' ? 'stocks-container' : 'funds-container');
        const newRow = document.createElement('div');
        newRow.className = 'stock-row';
        newRow.innerHTML = `<input type="text" placeholder="${type === 'stock' ? 'Hisse Kodu' : 'Fon Kodu'}" value="${ticker}" required><input type="number" placeholder="Ağırlık (%)" value="${weight}" min="0.01" step="0.01" required><input type="number" placeholder="Adet (Ops.)" value="${adet}" min="0" step="1"><button type="button" class="btn-remove" onclick="this.parentElement.remove()">X</button>`;
        container.appendChild(newRow);
    }

    function handleBackButtonClick(e) {
        e.preventDefault();
        if (currentSelectedItemName) {
            const activeLi = document.querySelector(`.sidebar-list li[data-name="${currentSelectedItemName}"]`);
            showOptions(currentSelectedItemName, currentView, activeLi);
        } else { showFormForNew(currentView); }
    }

    async function handleSave() {
        const name = document.getElementById('portfolio-name').value.trim().toUpperCase();
        if (!name) { alert('Lütfen bir ad veya kod girin.'); return; }
        const stocks = Array.from(document.querySelectorAll('#stocks-container .stock-row')).map(r => ({ ticker: r.children[0].value.trim().toUpperCase(), weight: r.children[1].value, adet: r.children[2].value }));
        const funds = Array.from(document.querySelectorAll('#funds-container .stock-row')).map(r => ({ ticker: r.children[0].value.trim().toUpperCase(), weight: r.children[1].value, adet: r.children[2].value }));
        const totalWeight = [...stocks, ...funds].reduce((sum, asset) => sum + parseFloat(asset.weight || 0), 0);
        if (Math.abs(totalWeight - 100) > 0.01) {
            if (!confirm(`Toplam ağırlık ${totalWeight.toFixed(2)}%. 100% değil. Yine de kaydetmek istiyor musunuz?`)) return;
        }
        const response = await fetch('/save_item', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: currentView, name, stocks, funds }) });
        const result = await response.json();
        alert(response.ok ? result.success : 'Hata: ' + result.error);
        if (response.ok) { currentView === 'portfolio' ? loadPortfolios() : loadCompositions(); showFormForNew(currentView); }
    }
    
    async function handleDeleteClick() {
        if (!currentSelectedItemName) { alert('Silmek için listeden bir öğe seçin.'); return; }
        const itemTypeText = currentView === 'portfolio' ? 'fonunu' : 'içeriğini';
        if (confirm(`"${currentSelectedItemName}" ${itemTypeText} silmek istediğinizden emin misiniz?`)) {
             const response = await fetch('/delete_item', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: currentView, name: currentSelectedItemName }) });
            const result = await response.json();
            alert(response.ok ? result.success : 'Hata: ' + result.error);
            if(response.ok) { currentView === 'portfolio' ? loadPortfolios() : loadCompositions(); showFormForNew(currentView); }
        }
    }

    async function handleFormCalculate(event) {
        event.preventDefault();
        showResultArea(true);
        const name = document.getElementById('portfolio-name').value.trim().toUpperCase() || "İsimsiz Portföy";
        const stocks = Array.from(document.querySelectorAll('#stocks-container .stock-row')).map(r => ({ ticker: r.children[0].value, weight: r.children[1].value }));
        const funds = Array.from(document.querySelectorAll('#funds-container .stock-row')).map(r => ({ ticker: r.children[0].value, weight: r.children[1].value }));
        try {
            const response = await fetch('/calculate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ stocks, funds }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            showResultArea(false);
            document.getElementById('result-title').textContent = `"${name}" Getiri Analizi`;
            const totalResultDiv = document.getElementById('total-result');
            totalResultDiv.textContent = `${result.total_change >= 0 ? '+' : ''}${result.total_change.toFixed(2)}%`;
            totalResultDiv.className = result.total_change >= 0 ? 'positive' : 'negative';
        } catch (error) { showResultArea(false); document.getElementById('total-result').innerHTML = `<span class="negative">Hata: ${error.message}</span>`; }
    }

    async function fetchAndDisplayLiveReturn(name, type) {
        const displayDiv = document.getElementById('live-return-display');
        displayDiv.textContent = 'Hesaplanıyor...'; displayDiv.className = '';
        const dataEndpoint = type === 'portfolio' ? `/get_portfolio/${name}` : `/get_composition/${name}`;
        const portfolioResponse = await fetch(dataEndpoint);
        if(!portfolioResponse.ok) { displayDiv.textContent = `Veri bulunamadı.`; displayDiv.className = 'negative'; return; }
        const portfolio = await portfolioResponse.json();
        const calculateResponse = await fetch('/calculate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ stocks: portfolio.stocks, funds: portfolio.funds }) });
        const result = await calculateResponse.json();
        if (calculateResponse.ok) {
            const value = result.total_change;
            displayDiv.textContent = `Anlık Getiri: ${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
            displayDiv.className = value >= 0 ? 'positive' : 'negative';
        } else { displayDiv.textContent = `Hata: ${result.error || 'Getiri hesaplanamadı.'}`; displayDiv.className = 'negative'; }
    }

    async function displayPieChartReport(name, type) {
        showScreen('report-container');
        document.getElementById('report-title').textContent = `"${name}" Fon Dağılımı`;
        const endpoint = type === 'portfolio' ? `/get_portfolio/${name}` : `/get_composition/${name}`;
        const response = await fetch(endpoint);
        const portfolio = await response.json();
        const assets = (portfolio.stocks || []).concat(portfolio.funds || []);
        const labels = assets.map(a => a.ticker); const data = assets.map(a => parseFloat(a.weight));
        const ctx = document.getElementById('portfolioPieChart').getContext('2d');
        if(portfolioChart) { portfolioChart.destroy(); }
        portfolioChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 50%)`)}] }, options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw.toFixed(2)}%` } } } } });
    }
    
    async function displayWeightChangeReport(name, type) {
        showScreen('comparison-container');
        const tableContainer = document.getElementById('comparison-table-container');
        const title = document.getElementById('comparison-title');
        title.textContent = `"${name}" Geçmişi Yükleniyor...`;
        tableContainer.innerHTML = '<div class="loader"></div>';
        try {
            const response = await fetch(`/get_item_history/${type}/${name}`);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            title.textContent = `"${name}" Değişim Raporu`;
            const allVersions = [data.current, ...data.history];
            if (allVersions.length < 2) { tableContainer.innerHTML = `<p style="text-align:center;">Karşılaştırma için en az bir geçmiş kayıt bulunmalıdır.</p>`; return; }
            let selectorHTML = `<div class="comparison-selector"><div><label for="select-version-A">Karşılaştırılacak:</label><select id="select-version-A"></select></div><div><label for="select-version-B">Temel Alınacak:</label><select id="select-version-B"></select></div></div><div id="dynamic-comparison-table"></div>`;
            tableContainer.innerHTML = selectorHTML;
            const selectA = document.getElementById('select-version-A');
            const selectB = document.getElementById('select-version-B');
            allVersions.forEach((v, i) => { const ts = i === 0 ? "Güncel Versiyon" : v.display_timestamp; selectA.options[i] = new Option(ts, i); selectB.options[i] = new Option(ts, i); });
            selectA.value = 0; selectB.value = 1;
            const renderTable = () => {
                const vA = allVersions[selectA.value], vB = allVersions[selectB.value];
                const assetsA = { ...((vA.stocks || []).reduce((o, i) => (o[i.ticker.toUpperCase()] = i, o), {})), ...((vA.funds || []).reduce((o, i) => (o[i.ticker.toUpperCase()] = i, o), {})) };
                const assetsB = { ...((vB.stocks || []).reduce((o, i) => (o[i.ticker.toUpperCase()] = i, o), {})), ...((vB.funds || []).reduce((o, i) => (o[i.ticker.toUpperCase()] = i, o), {})) };
                const allTickers = [...new Set([...Object.keys(assetsA), ...Object.keys(assetsB)])].sort();
                const dateA = selectA.value == 0 ? "Güncel" : vA.display_timestamp, dateB = selectB.value == 0 ? "Güncel" : vB.display_timestamp;
                let table = `<table class="detail-table"><thead><tr><th rowspan="2">Varlık</th><th colspan="3">Ağırlık</th><th colspan="3">Adet</th></tr><tr><th>${dateA}</th><th>${dateB}</th><th>Fark</th><th>${dateA}</th><th>${dateB}</th><th>Fark</th></tr></thead><tbody>`;
                allTickers.forEach(ticker => {
                    const assetA = assetsA[ticker] || {w:0, a:0}, assetB = assetsB[ticker] || {w:0, a:0};
                    const wA = parseFloat(assetA.weight||0), wB = parseFloat(assetB.weight||0), wCh = wA-wB;
                    const aA = parseInt(assetA.adet||0), aB = parseInt(assetB.adet||0), aCh = aA-aB;
                    table += `<tr><td><b>${ticker}</b></td><td>${wA.toFixed(2)}%</td><td>${wB.toFixed(2)}%</td><td class="${wCh>0?'pos':wCh<0?'neg':''}">${wCh.toFixed(2)}%</td><td>${aA}</td><td>${aB}</td><td class="${aCh>0?'pos':aCh<0?'neg':''}">${aCh}</td></tr>`;
                });
                table += `</tbody></table><button type="button" class="btn-revert" onclick="revertItem('${name}', '${type}')">En Son Değişikliği Geri Al</button>`;
                document.getElementById('dynamic-comparison-table').innerHTML = table;
            };
            selectA.onchange = renderTable; selectB.onchange = renderTable; renderTable();
        } catch (error) { title.textContent = 'Hata'; tableContainer.innerHTML = `<p class="negative">Hata: ${error.message}</p>`; }
    }

    async function revertItem(name, type) {
        if (confirm(`"${name}" için son değişikliği geri almak istediğinizden emin misiniz?`)) {
            const response = await fetch(`/revert_item/${type}/${name}`, { method: 'POST' });
            const result = await response.json();
            alert(response.ok ? result.success : 'Hata: ' + result.error);
            if (response.ok) { displayWeightChangeReport(name, type); }
        }
    }

    async function displayHistoricalReturns(name, type) {
        showResultArea(true);
        document.getElementById('historical-results-container').style.display = 'block';
        document.getElementById('result-title').textContent = `"${name}" - Son 30 Günlük Getiri`;
        try {
            const response = await fetch(`/calculate_historical/${type}/${name}`);
            const data = await response.json();
            if (!response.ok) { throw new Error(data.error); }
            showResultArea(false); document.getElementById('historical-results-container').style.display = 'block';
            const ctx = document.getElementById('historicalLineChart').getContext('2d');
            if (historicalChart) { historicalChart.destroy(); }
            historicalChart = new Chart(ctx, { type: 'line', data: { labels: data.dates, datasets: [{ label: 'Günlük Getiri (%)', data: data.returns, borderColor: 'rgb(54, 162, 235)', tension: 0.1, pointBackgroundColor: data.returns.map(v => v >= 0 ? '#27ae60' : '#c0392b') }] }, options: { scales: { y: { title: { display: true, text: 'Günlük Getiri (%)' } } } } });
        } catch (error) { showResultArea(false); document.getElementById('total-result').innerHTML = `<span class="negative">Hata: ${error.message}</span>`; }
    }

    async function displayDynamicWeightSimulation(name, type) {
        showResultArea(true);
        document.getElementById('result-title').textContent = `"${name}" - Dinamik Ağırlık Simülasyonu`;
        try {
            const endpoint = type === 'portfolio' ? `/get_portfolio/${name}` : `/get_composition/${name}`;
            const portfolioResponse = await fetch(endpoint);
            const portfolio = await portfolioResponse.json();
            if (![...(portfolio.stocks || []), ...(portfolio.funds || [])].some(a => a.adet > 0)) { throw new Error('Bu simülasyon için en az bir varlığa adet girilmiş olmalıdır.'); }
            const response = await fetch('/calculate_dynamic_weights', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(portfolio) });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.error); }
            showResultArea(false);
            const totalResultDiv = document.getElementById('total-result');
            totalResultDiv.textContent = `${result.total_change >= 0 ? '+' : ''}${result.total_change.toFixed(2)}%`;
            totalResultDiv.className = result.total_change >= 0 ? 'positive' : 'negative';
            const container = document.getElementById('stock-results-container');
            container.innerHTML = '<h3>Simülasyon Detayları</h3>' + buildSimulationDetailsTable(result.details);
            container.style.display = 'block';
        } catch (error) { showResultArea(false); document.getElementById('total-result').innerHTML = `<span class="negative">Hata: ${error.message}</span>`; }
    }
    
    function buildSimulationDetailsTable(details) {
        let table = '<table class="detail-table"><thead><tr><th>Varlık</th><th>Dinamik Ağırlık</th><th>Günlük Değişim</th><th>Ağırlıklı Etki</th></tr></thead><tbody>';
        details.forEach(item => {
            table += `<tr><td><b>${item.ticker}</b>${item.error?'<br><small class="negative">(Fiyat alınamadı)</small>':''}</td><td>${item.dynamic_weight.toFixed(2)}%</td><td class="${item.daily_change > 0 ? 'positive' : 'negative'}">${item.daily_change.toFixed(2)}%</td><td class="${item.weighted_impact > 0 ? 'positive' : 'negative'}">${item.weighted_impact.toFixed(4)}%</td></tr>`;
        });
        return table + '</tbody></table>';
    }

    function showResultArea(isLoading) {
        showScreen('result-area');
        document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
        document.getElementById('result-content').style.display = isLoading ? 'none' : 'block';
        if (!isLoading) {
            document.getElementById('total-result').innerHTML = '';
            ['stock-results-container', 'fund-results-container', 'historical-results-container'].forEach(id => document.getElementById(id).style.display = 'none');
        }
    }
</script>
</body>
</html>
